<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Agendamentos - Servite</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body { font-family: Arial, sans-serif; background-color: #f2f2f2; margin: 0; padding: 0; }
        header { background-color: #4a4a4a; color: #fff; padding: 1em; text-align: center; }
        main { padding: 2em; max-width: 900px; margin: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 1em; background: #fff; }
        th, td { border: 1px solid #ccc; padding: 0.5em; text-align: left; }
        th { background-color: #eee; }
        button { padding: 0.5em 1em; margin: 0.2em; cursor: pointer; }
        form { display: grid; grid-template-columns: 1fr 1fr; gap: 1em; background: #fff; padding: 1em; border-radius: 8px; }
        label { display: block; margin-bottom: 0.2em; font-weight: bold; }
        input, select { width: 100%; padding: 0.5em; border: 1px solid #ccc; border-radius: 4px; }
        .full { grid-column: 1 / -1; }
    </style>
</head>
<body>
<header>
    <h1>Agendamentos - Servite</h1>
</header>
<main>
    <form id="formAgendamento">
        <input type="hidden" id="agendamentoId">
        <div>
            <label for="clienteId">Cliente</label>
            <input type="number" id="clienteId" required>
        </div>
        <div>
            <label for="prestadorId">Prestador</label>
            <input type="number" id="prestadorId" required>
        </div>
        <div>
            <label for="servicoId">Serviço/Produto</label>
            <select id="servicoId" required></select>
        </div>
        <div>
            <label for="dataAgendamento">Data</label>
            <input type="date" id="dataAgendamento" required>
        </div>
        <div>
            <label for="horaAgendamento">Hora</label>
            <input type="time" id="horaAgendamento" required>
        </div>
        <div>
            <label for="valor">Valor</label>
            <input type="number" step="0.01" id="valor" required>
        </div>
        <div>
            <label for="taxa">Taxa</label>
            <input type="number" step="0.01" id="taxa">
        </div>
        <div class="full">
            <button type="submit">Salvar Agendamento</button>
        </div>
    </form>

    <table id="tabelaAgendamentos">
        <thead>
            <tr>
                <th>ID</th>
                <th>Cliente</th>
                <th>Prestador</th>
                <th>Serviço</th>
                <th>Data</th>
                <th>Hora</th>
                <th>Valor</th>
                <th>Status</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</main>

<script>
const apiUrl = 'api/agendamento.php';
const servicoSelect = document.getElementById('servicoId');
const tabelaBody = document.querySelector('#tabelaAgendamentos tbody');
const form = document.getElementById('formAgendamento');

// Carregar serviços para select
fetch('api/servico_produto.php')
    .then(res => res.json())
    .then(data => {
        data.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s.id;
            opt.textContent = `${s.titulo} (${s.tipo || 'Serviço'})`;
            servicoSelect.appendChild(opt);
        });
    });

// Carregar agendamentos
function carregarAgendamentos() {
    fetch(apiUrl)
        .then(res => res.json())
        .then(data => {
            tabelaBody.innerHTML = '';
            data.forEach(a => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${a.id}</td>
                    <td>${a.cliente_nome}</td>
                    <td>${a.prestador_nome}</td>
                    <td>${a.servico_titulo}</td>
                    <td>${a.data_agendamento}</td>
                    <td>${a.hora_agendamento}</td>
                    <td>${a.valor}</td>
                    <td>${a.status}</td>
                    <td>
                        <button onclick="editarAgendamento(${a.id})">Editar</button>
                        <button onclick="deletarAgendamento(${a.id})">Excluir</button>
                    </td>
                `;
                tabelaBody.appendChild(tr);
            });
        });
}

// Editar agendamento
function editarAgendamento(id) {
    fetch(`${apiUrl}?id=${id}`)
        .then(res => res.json())
        .then(a => {
            document.getElementById('agendamentoId').value = a[0].id;
            document.getElementById('clienteId').value = a[0].cliente_id;
            document.getElementById('prestadorId').value = a[0].prestador_id;
            document.getElementById('servicoId').value = a[0].servico_id;
            document.getElementById('dataAgendamento').value = a[0].data_agendamento;
            document.getElementById('horaAgendamento').value = a[0].hora_agendamento;
            document.getElementById('valor').value = a[0].valor;
            document.getElementById('taxa').value = a[0].taxa || 0;
        });
}

// Deletar agendamento
function deletarAgendamento(id) {
    if (!confirm('Deseja realmente excluir este agendamento?')) return;
    fetch(`${apiUrl}?id=${id}`, { method: 'DELETE' })
        .then(res => res.json())
        .then(() => carregarAgendamentos());
}

// Submeter formulário
form.addEventListener('submit', e => {
    e.preventDefault();
    const id = document.getElementById('agendamentoId').value;
    const payload = {
        cliente_id: document.getElementById('clienteId').value,
        prestador_id: document.getElementById('prestadorId').value,
        servico_id: document.getElementById('servicoId').value,
        data_agendamento: document.getElementById('dataAgendamento').value,
        hora_agendamento: document.getElementById('horaAgendamento').value,
        valor: parseFloat(document.getElementById('valor').value),
        taxa: parseFloat(document.getElementById('taxa').value || 0)
    };

    const method = id ? 'PUT' : 'POST';
    const url = id ? `${apiUrl}?id=${id}` : apiUrl;

    fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(() => {
        form.reset();
        document.getElementById('agendamentoId').value = '';
        carregarAgendamentos();
    });
});

// Inicial
carregarAgendamentos();
</script>
</body>
</html>
